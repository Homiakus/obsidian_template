# Архитектура Mask Builder Plugin

## Обзор

Mask Builder Plugin - это модульный плагин для Obsidian, который обеспечивает создание и управление заметками на основе масок CTM (Context-Type-Model). Плагин следует принципам чистой архитектуры и использует современные практики разработки.

## Архитектурные принципы

### 1. Модульность
- Каждый модуль имеет четко определенную ответственность
- Минимальные зависимости между модулями
- Возможность независимого тестирования

### 2. Типобезопасность
- Строгая типизация TypeScript
- Валидация схем с помощью Zod
- Компиляция времени выполнения

### 3. Производительность
- Ленивая загрузка модулей
- Debounced обработка событий
- Эффективное кэширование

### 4. Надежность
- Обработка ошибок на всех уровнях
- Валидация входных данных
- Безопасные операции с файлами

## Структура модулей

```
src/
├── main.ts                    # Точка входа плагина
├── settings.ts                # Управление настройками
├── ui/                        # Пользовательский интерфейс
│   ├── settings-tab.ts        # Вкладка настроек
│   └── mask-builder-modal.ts  # Модальное окно создания масок
└── utils/                     # Утилиты и бизнес-логика
    ├── mask-parser.ts         # Парсер и валидатор масок
    └── file-manager.ts        # Менеджер файлов
```

## Основные компоненты

### 1. MaskBuilderPlugin (main.ts)
**Ответственность**: Координация всех компонентов плагина

**Основные функции**:
- Инициализация и загрузка плагина
- Регистрация команд и обработчиков событий
- Координация между UI и бизнес-логикой

**Зависимости**:
- Settings
- UI компоненты
- Утилиты

### 2. Settings (settings.ts)
**Ответственность**: Управление настройками плагина

**Основные функции**:
- Определение схемы настроек
- Валидация настроек
- Миграции версий

**Схема настроек**:
```typescript
const SettingsSchema = z.object({
  enabled: z.boolean().default(true),
  autoCreateFolders: z.boolean().default(true),
  maskValidation: z.boolean().default(true),
  // ... другие настройки
});
```

### 3. MaskParser (utils/mask-parser.ts)
**Ответственность**: Парсинг и валидация масок CTM

**Основные функции**:
- Парсинг строк масок в структурированные объекты
- Валидация масок согласно правилам CTM
- Генерация имен файлов и путей

**Формат маски**:
```
E[-S][.A1][.A2]...[.L][.C][.F][+R...][@ANCHOR]
```

### 4. FileManager (utils/file-manager.ts)
**Ответственность**: Безопасные операции с файлами

**Основные функции**:
- Создание файлов на основе масок
- Перемещение файлов между папками
- Управление фронтматтером

**Безопасность**:
- Проверка существования файлов
- Создание папок при необходимости
- Обработка ошибок

### 5. UI Components
**MaskBuilderModal**: Модальное окно для создания масок
- Форма с валидацией
- Предварительный просмотр
- Интуитивный интерфейс

**MaskBuilderSettingTab**: Вкладка настроек
- Группированные настройки
- Валидация в реальном времени
- Сохранение настроек

## Поток данных

### Создание заметки
1. Пользователь открывает Mask Builder
2. Заполняет форму создания маски
3. MaskParser валидирует маску
4. FileManager создает файл
5. Плагин обновляет фронтматтер
6. Файл автоматически перемещается в нужную папку

### Автоматическая категоризация
1. Событие создания/переименования файла
2. MaskParser извлекает маску из имени файла
3. Валидация маски
4. Обновление фронтматтера
5. Перемещение файла в соответствующую папку

## Обработка событий

### Debounced обработка
```typescript
this.debouncedProcessFile = debounce(
  (file: TFile) => this.processFile(file),
  this.settings.debounceDelay,
  true
);
```

### Регистрация событий
```typescript
this.registerEvent(
  this.app.vault.on("create", (file) => {
    if (file instanceof TFile && this.settings.autoCategorize) {
      this.debouncedProcessFile(file);
    }
  })
);
```

## Безопасность

### Валидация входных данных
- Все пользовательские входы валидируются через Zod
- Проверка типов на этапе компиляции
- Валидация масок согласно правилам CTM

### Безопасные операции с файлами
- Проверка существования файлов перед операциями
- Создание папок при необходимости
- Обработка ошибок с информативными сообщениями

### Защита от гонок
- Debounced обработка событий
- Проверка состояния файлов перед операциями
- Корректная очистка ресурсов

## Производительность

### Кэширование
- Кэш парсинга масок
- Кэш операций с файлами
- Настраиваемый размер кэша

### Ленивая загрузка
- Модули загружаются по требованию
- Тяжелые операции выполняются асинхронно
- Минимизация блокировки UI

### Оптимизация событий
- Debounced обработка файловых событий
- Группировка операций
- Отписка от событий при выгрузке

## Тестирование

### Unit тесты
- Тестирование каждого модуля независимо
- Мокирование зависимостей
- Покрытие критических путей

### Интеграционные тесты
- Тестирование взаимодействия модулей
- Тестирование с реальными файлами
- Проверка производительности

## Расширяемость

### Точки расширения
- Пользовательские области знаний
- Пользовательские форматы файлов
- Пользовательские шаблоны

### API для расширений
- Экспорт основных классов
- События для интеграции
- Хуки для кастомизации

## Миграции

### Версионирование настроек
- Схема версий настроек
- Автоматические миграции
- Обратная совместимость

### Обработка изменений
- Валидация старых настроек
- Преобразование в новый формат
- Сохранение пользовательских данных

## Мониторинг и логирование

### Логирование
- Подробные логи операций
- Логирование ошибок
- Отладочная информация

### Метрики
- Время выполнения операций
- Количество обработанных файлов
- Статистика использования функций